#include "ui_display.h"
#include "hardware.h"
#include "app_config.h"
#include "menu_data.h"
#include "cjson.h"
#include <stdio.h>
#include <string.h>

// UPI QR Code Bitmap (128x48)
const unsigned char epd_bitmap_qr_code[] = {
	0xff, 0xff, 0xff, 0x0f, 0x07, 0xe7, 0xe7, 0x67, 0x67, 0x67, 0x67, 0x67, 0xe7, 0xe7, 0x07, 0x0f, 
	0xff, 0xff, 0xff, 0x07, 0x07, 0x67, 0x67, 0x67, 0x07, 0x0f, 0xff, 0xff, 0x67, 0x47, 0x87, 0x1f, 
	0x1f, 0x1f, 0x3f, 0xff, 0x6f, 0x67, 0x67, 0x6f, 0x9f, 0x9f, 0x9f, 0x0f, 0x07, 0x9f, 0x9f, 0xff, 
	0x0f, 0x07, 0xc7, 0xe7, 0x67, 0x67, 0x67, 0x67, 0x67, 0xe7, 0xe7, 0x07, 0x0f, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x80, 0x00, 0x3f, 0x3f, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3f, 0x1f, 0x00, 0x80, 
	0xff, 0x9f, 0x0f, 0xfc, 0xf8, 0x00, 0x00, 0xfc, 0xbc, 0xbc, 0xcd, 0xcd, 0x0e, 0x1f, 0xff, 0xb7, 
	0x32, 0xfc, 0x7e, 0x3f, 0xf7, 0xf6, 0x0e, 0x0e, 0xcd, 0x33, 0x33, 0xcf, 0xce, 0x3f, 0x3f, 0xff, 
	0x80, 0x00, 0x1f, 0x3f, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3f, 0x3f, 0x00, 0x80, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xc3, 0x81, 0x7f, 0x7f, 0x1f, 0x1f, 0x61, 0x7f, 0x7f, 0x83, 0x81, 0x99, 0xdb, 
	0xff, 0x1f, 0x19, 0x19, 0x09, 0x00, 0x00, 0x99, 0xff, 0xff, 0xfb, 0xf9, 0x60, 0x70, 0x79, 0x87, 
	0x87, 0x1e, 0x8c, 0xe1, 0x10, 0x18, 0x24, 0x64, 0x98, 0x98, 0x98, 0xff, 0xff, 0xfe, 0xfe, 0xe1, 
	0xe3, 0xe7, 0x7b, 0x7b, 0xff, 0xff, 0x67, 0x9f, 0x9f, 0x67, 0x67, 0x07, 0x07, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xf9, 0xf0, 0xb3, 0xb3, 0x43, 0x43, 0xbf, 0x38, 0x10, 0x03, 0x03, 0x4c, 0x45, 
	0x43, 0x03, 0x03, 0x03, 0x00, 0x40, 0x40, 0x4c, 0x00, 0x01, 0x43, 0x43, 0x3f, 0x3f, 0xb3, 0xf3, 
	0xf3, 0x33, 0x17, 0x4f, 0x1e, 0x3c, 0x4e, 0x4f, 0x0f, 0x37, 0x73, 0x83, 0x03, 0x1d, 0x3c, 0xfc, 
	0xfc, 0x7c, 0x7f, 0x7f, 0x63, 0x43, 0x0f, 0xf3, 0xf3, 0xe3, 0xe3, 0x70, 0xf8, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xf1, 0x31, 0xc3, 0xc3, 0xf0, 0xf0, 0x39, 0xf0, 0xf0, 0xfe, 0xfe, 0x36, 0xb2, 
	0xc8, 0xc8, 0xdc, 0xfe, 0x7e, 0x0e, 0x0e, 0xf6, 0xf6, 0x36, 0x3e, 0x7e, 0xf0, 0x70, 0x3f, 0x1d, 
	0x0d, 0x0e, 0x0c, 0x00, 0x1c, 0x3e, 0x76, 0xf2, 0xc8, 0x20, 0x36, 0x09, 0x09, 0x30, 0x30, 0x33, 
	0x77, 0xf6, 0x76, 0x36, 0xfe, 0xfe, 0xc6, 0xe1, 0xf1, 0x33, 0x27, 0xc6, 0xc7, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xfb, 0x99, 0xe1, 0xe3, 0x87, 0xcf, 0xfe, 0xc1, 0x81, 0x87, 0x87, 0x99, 0x9b, 
	0x87, 0x46, 0x6e, 0x9e, 0x9c, 0x60, 0x60, 0x99, 0xe1, 0xe3, 0x9f, 0x9f, 0x1e, 0x1c, 0x98, 0x84, 
	0xce, 0xfe, 0xf8, 0xe0, 0x1c, 0x1c, 0x18, 0x10, 0x81, 0x7c, 0x7e, 0x8f, 0x87, 0x00, 0x00, 0x98, 
	0x84, 0x86, 0x99, 0x9b, 0x1f, 0x1f, 0x61, 0x10, 0x18, 0xff, 0xff, 0x78, 0x78, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x01, 0x00, 0xf8, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0xfc, 0xf8, 0x00, 0x01, 
	0xff, 0xbf, 0xb3, 0xb3, 0x13, 0x0c, 0x0c, 0x33, 0x33, 0xb3, 0x40, 0x40, 0x3f, 0x1f, 0x8f, 0xc7, 
	0xe7, 0xff, 0xff, 0x7f, 0x87, 0x83, 0x93, 0xb3, 0xbc, 0x5f, 0x4f, 0x3f, 0x3f, 0x00, 0x00, 0x0f, 
	0x0d, 0x8c, 0x8f, 0x8f, 0x00, 0x00, 0x70, 0x7e, 0x7f, 0x8f, 0x8f, 0x43, 0xe7, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xf0, 0xe0, 0xe7, 0xe7, 0xe6, 0xe6, 0xe6, 0xe6, 0xe6, 0xe7, 0xe7, 0xe0, 0xf0, 
	0xff, 0xf7, 0xf7, 0xff, 0xff, 0xfe, 0xfc, 0xe0, 0xe1, 0xe1, 0xe6, 0xf6, 0xfe, 0xfe, 0xf9, 0xf1, 
	0xf1, 0xf9, 0xfd, 0xfe, 0xff, 0xff, 0xf7, 0xe7, 0xe1, 0xfe, 0xfe, 0xf8, 0xf8, 0xf1, 0xe1, 0xe6, 
	0xf9, 0xf9, 0xf7, 0xe7, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xf7, 0xe7, 0xfe, 0xfe, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};




void ui_display_idle(void) {
    oled_clear_buffer();
    oled_write_centered("AutoDine", 20, false);
    oled_draw_hline(20, 30, 88);
    oled_write_centered("Press B1 for", 38, false);
    oled_write_centered("menu", 50, false);
    oled_display();
}

void ui_display_menu(uint8_t menu_index, cart_t *cart) {
    oled_clear_buffer();
    
    // Item counter (top-left, subtle)
    char num[8];
    snprintf(num, sizeof(num), "%d/%d", menu_index + 1, MENU_ITEMS_COUNT);
    oled_write_string(num, 2, 2, false);
    
    // Item name (centered, max 16 chars)
    char name[32];
    if (strlen(MENU_DATABASE[menu_index].name) > 16) {
        snprintf(name, sizeof(name), "%.13s...", MENU_DATABASE[menu_index].name);
    } else {
        snprintf(name, sizeof(name), "%s", MENU_DATABASE[menu_index].name);
    }
    oled_write_centered(name, 20, false);
    
    // Price (centered, emphasized)
    char price[12];
    snprintf(price, sizeof(price), "Rs %d", MENU_DATABASE[menu_index].price);
    oled_write_centered(price, 36, false);
    
    // Cart summary (bottom, subtle)
    if (!cart_is_empty(cart)) {
        char cart_txt[16];
        snprintf(cart_txt, sizeof(cart_txt), "Cart:%d Rs%lu", 
                cart->count, (unsigned long)cart->total);
        oled_write_string(cart_txt, 2, 56, false);
    }
    
    oled_display();
}

void ui_display_quantity(uint8_t menu_index, uint8_t qty) {
    oled_clear_buffer();
    
    // Item name (top, max 16 chars)
    char name[32];
    if (strlen(MENU_DATABASE[menu_index].name) > 16) {
        snprintf(name, sizeof(name), "%.13s...", MENU_DATABASE[menu_index].name);
    } else {
        snprintf(name, sizeof(name), "%s", MENU_DATABASE[menu_index].name);
    }
    oled_write_centered(name, 4, false);
    
    // Large quantity number (centered, dominant)
    char qty_str[4];
    snprintf(qty_str, sizeof(qty_str), "%d", qty);
    oled_write_centered(qty_str, 26, true);
    
    // Separator line
    oled_draw_hline(0, 50, 128);
    
    // Hint (bottom, subtle)
    oled_write_string("B3=Add B4=Back", 12, 56, false);
    
    oled_display();
}

void ui_display_waiting_order(void) {
    oled_clear_buffer();
    oled_write_centered("Waiting for", 20, false);
    oled_write_centered("order to be", 32, false);
    oled_write_centered("accepted", 44, false);
    oled_display();
}

void ui_display_order_declined(void) {
    oled_clear_buffer();
    oled_write_centered("Sorry!", 20, false);
    oled_write_centered("Order", 32, false);
    oled_write_centered("unavailable", 44, false);
    oled_display();
}

void ui_display_cooking(void) {
    oled_clear_buffer();
    oled_write_centered("Food is", 16, false);
    oled_write_centered("preparing", 28, false);
    oled_write_centered("10-15 min", 40, false);
    oled_draw_hline(0, 50, 128);
    oled_write_string("B3=Add more", 24, 56, false);
    oled_display();
}

void ui_display_food_prepared(void) {
    oled_clear_buffer();
    oled_write_centered("Food is", 16, false);
    oled_write_centered("prepared!", 28, false);
    oled_write_centered("Enjoy meal", 40, false);
    oled_draw_hline(0, 50, 128);
    oled_write_string("B3=More B4=Bill", 8, 56, false);
    oled_display();
}

void ui_display_order_declined_append(void) {
    oled_clear_buffer();
    oled_write_centered("Items not", 24, false);
    oled_write_centered("available", 40, false);
    oled_display();
}

void ui_display_waiting_bill(void) {
    oled_clear_buffer();
    oled_write_centered("Waiting for", 24, false);
    oled_write_centered("bill", 40, false);
    oled_display();
}

void ui_display_bill(const char *bill_json, uint8_t scroll_index) {
    oled_clear_buffer();
    
    if (!bill_json || strlen(bill_json) == 0) {
        oled_write_centered("No bill", 28, false);
        oled_display();
        return;
    }
    
    cJSON *root = cJSON_Parse(bill_json);
    if (!root) {
        oled_write_centered("Error", 28, false);
        oled_display();
        return;
    }
    
    // Get totals
    cJSON *subtotal = cJSON_GetObjectItem(root, "subtotal");
    cJSON *gst = cJSON_GetObjectItem(root, "gst");
    cJSON *grand = cJSON_GetObjectItem(root, "grand_total");
    
    int sub_val = subtotal ? (int)subtotal->valuedouble : 0;
    int gst_val = gst ? (int)gst->valuedouble : 0;
    int total_val = grand ? (int)grand->valuedouble : 0;
    
    char line_buf[16];
    
    // Title (small, top)
    oled_write_centered("BILL", 4, false);
    
    // Subtotal (clear, left-aligned label, right-aligned value)
    oled_write_string("Subtotal", 8, 20, false);
    snprintf(line_buf, sizeof(line_buf), "Rs %d", sub_val);
    uint8_t sub_x = 120 - (strlen(line_buf) * 6);
    oled_write_string(line_buf, sub_x, 20, false);
    
    // GST (clear, left-aligned label, right-aligned value)
    oled_write_string("GST 18%", 8, 32, false);
    snprintf(line_buf, sizeof(line_buf), "Rs %d", gst_val);
    uint8_t gst_x = 120 - (strlen(line_buf) * 6);
    oled_write_string(line_buf, gst_x, 32, false);
    
    // Total (LARGE, centered, dominant)
    oled_write_centered("TOTAL", 46, false);
    snprintf(line_buf, sizeof(line_buf), "Rs %d", total_val);
    oled_write_centered(line_buf, 56, false);
    
    cJSON_Delete(root);
    oled_display();
}

void ui_display_payment_method_select(void) {
    oled_clear_buffer();
    oled_write_centered("Payment", 12, false);
    oled_write_string("1. UPI", 32, 28, false);
    oled_write_string("2. Cash/Card", 20, 40, false);
    oled_draw_hline(0, 50, 128);
    oled_write_string("B1=UPI B2=Cash", 10, 56, false);
    oled_display();
}

void ui_display_upi_qr(const char *upi_url) {
    oled_clear_buffer();
    oled_draw_bitmap(epd_bitmap_qr_code);
    oled_display();
}

void ui_display_cash_wait(void) {
    oled_clear_buffer();
    oled_write_centered("Please pay", 20, false);
    oled_write_centered("at counter", 32, false);
    oled_write_centered("Cash/Card", 44, false);
    oled_display();
}

void ui_display_thank_you(void) {
    oled_clear_buffer();
    oled_write_centered("Thank you!", 24, false);
    oled_write_centered("Visit again", 40, false);
    oled_display();
}

void ui_render_current_state(state_context_t *ctx, cart_t *cart, const char *bill_data) {
    if (!ctx) return;
    
    switch (ctx->current) {
        case STATE_IDLE:
            ui_display_idle();
            break;
        case STATE_MENU_BROWSE:
            ui_display_menu(ctx->menu_index, cart);
            break;
        case STATE_QUANTITY_SELECT:
            ui_display_quantity(ctx->menu_index, ctx->quantity);
            break;
        case STATE_WAITING_ORDER_ACCEPT:
            ui_display_waiting_order();
            break;
        case STATE_ORDER_DECLINED:
            ui_display_order_declined();
            break;
        case STATE_ORDER_DECLINED_APPEND:
            ui_display_order_declined_append();
            break;
        case STATE_COOKING:
            ui_display_cooking();
            break;
        case STATE_FOOD_PREPARED:
            ui_display_food_prepared();
            break;
        case STATE_WAITING_BILL:
            ui_display_waiting_bill();
            break;
        case STATE_BILL_DISPLAY:
            ui_display_bill(bill_data, ctx->bill_scroll_index);
            break;
        case STATE_PAYMENT_METHOD_SELECT:
            ui_display_payment_method_select();
            break;
        case STATE_PAYMENT_QR_UPI:
            ui_display_upi_qr("");
            break;
        case STATE_PAYMENT_CASH:
            ui_display_cash_wait();
            break;
        case STATE_THANK_YOU:
            ui_display_thank_you();
            break;
        default:
            break;
    }
}
